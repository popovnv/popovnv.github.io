<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Асинхронное подтверждение транзакций</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="Документация по PostgreSQL 9.4.1"
HREF="index.html"><LINK
REL="UP"
TITLE="Надёжность и журнал упреждающей записи"
HREF="wal.html"><LINK
REL="PREVIOUS"
TITLE="Журнал упреждающей записи (WAL)"
HREF="wal-intro.html"><LINK
REL="NEXT"
TITLE="Настройка WAL"
HREF="wal-configuration.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"><META
NAME="creation"
CONTENT="2016-04-12T07:56:57"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>Документация по PostgreSQL 9.4.1</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Журнал упреждающей записи (WAL)"
HREF="wal-intro.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Глава 29. Надёжность и журнал упреждающей записи</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Настройка WAL"
HREF="wal-configuration.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WAL-ASYNC-COMMIT"
>29.3. Асинхронное подтверждение транзакций</A
></H1
><P
><I
CLASS="FIRSTTERM"
>Асинхронная фиксация</I
> &mdash; это возможность завершать транзакции быстрее, ценой того, что в случае краха СУБД последние транзакции могут быть потеряны. Для многих приложений такой компромисс приемлем.</P
><P
>Как описано в предыдущей части, подтверждение транзакции обычно <I
CLASS="FIRSTTERM"
>синхронное</I
>: сервер ждёт сохранения записей <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> транзакции в постоянном хранилище, прежде чем сообщить клиенту об успешном завершении. Таким образом, клиенту гарантируется, что транзакция, которую подтвердил сервер, будет защищена, даже если сразу после этого произойдёт крах сервера. Однако, для коротких транзакций данная задержка будет основной составляющей общего времени транзакции. В режиме асинхронного подтверждения сервер сообщает об успешном завершении сразу, как только транзакция будет завершена логически, прежде чем сгенерированные записи <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> фактически будут записаны на диск. Это может значительно увеличить производительность при выполнении небольших транзакций.</P
><P
>Асинхронное подтверждение транзакций приводит к риску потери данных. Существует короткое окно между отчётом о завершении транзакции для клиента и временем, когда транзакция реально подтверждена (т. е. гарантируется, что она не будет потеряна в случае краха сервера). Таким образом, асинхронное подтверждение транзакций не должно использоваться, если клиент будет выполнять внешние действия, опираясь на предположение, что транзакция будет сохранена. Например, банк конечно не должен использовать асинхронное подтверждение для транзакций в банкоматах, выдающих наличные. Но во многих случаях, таких как журналирование событий, столь серьёзная гарантия сохранности данных не нужна.</P
><P
>Риск потери данных при использовании асинхронного подтверждения транзакций &mdash; это не риск повреждения данных. Если случился крах СУБД, она будет восстановлена путём воспроизведения <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> до последней записи, которая была записана на диск. Таким образом, будет восстановлено целостное состояние СУБД, но любые транзакции, которые ещё не были сохранены на диск, в этом состоянии не будут отражены. Чистый эффект будет заключаться в потере нескольких последних транзакций. Поскольку транзакции воспроизводятся в том же порядке, в котором подтверждались, воспроизведение не нарушает целостность &mdash; например, если транзакция "B" выполнила изменения, которые влияют на предыдущую транзакцию "A", то не может быть такого, что изменения, выполненные "A" были потеряны, а изменения, внесённые "B" сохранены.</P
><P
>Пользователь может выбрать режим подтверждения для каждой транзакции, так что возможен конкурентный запуск транзакций в синхронном и асинхронном режиме. Это позволяет достичь гибкого компромисса между производительностью и конечно надёжностью транзакций. Режим подтверждения транзакций управляется параметром <A
HREF="runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT"
>synchronous_commit</A
>, который может быть изменён любым из способов, пригодным для установки параметров конфигурации. Режим, используемый для какой-либо конкретной транзакции, зависит от значения <TT
CLASS="VARNAME"
>synchronous_commit</TT
>, которое действует на момент начала этой транзакции.</P
><P
>Некоторые команды, например <TT
CLASS="COMMAND"
>DROP TABLE</TT
>, принудительно запускают синхронное подтверждение транзакции, независимо от значения <TT
CLASS="VARNAME"
>synchronous_commit</TT
>. Это сделано для того, чтобы иметь уверенность в целостности данных между файловой системой сервера и логическим состоянием базы данных. Команды, которые поддерживают двухфазное подтверждение транзакций, такие как <TT
CLASS="COMMAND"
>PREPARE TRANSACTION</TT
>, также всегда синхронные.</P
><P
>Если во время окна риска между асинхронным подтверждением транзакции и сохранением на диск записей <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
>, происходит крах СУБД, то изменения, сделанные во время этой транзакции <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>будут</I
></SPAN
> потеряны. Продолжительность окна риска ограничена, потому что фоновый процесс (<SPAN
CLASS="QUOTE"
>"WAL writer"</SPAN
>), сохраняет не записанные записи <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> на диск каждые <A
HREF="runtime-config-wal.html#GUC-WAL-WRITER-DELAY"
>wal_writer_delay</A
> миллисекунд. Фактически, максимальная продолжительность окна риска составляет трёхкратное значение <TT
CLASS="VARNAME"
>wal_writer_delay</TT
>, потому что WAL writer разработан так, чтобы сразу сохранять целые страницы во время периодов занятости.</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>Предостережение</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
>Режим немедленного завершения работы (immediate) эквивалентен краху сервера и приведёт, таким образом, к потере всех не сохранённых асинхронных транзакций.</P
></TD
></TR
></TABLE
></DIV
><P
>Асинхронное подтверждение транзакций предоставляет поведение, которое отличается от того, что соответствует установке параметра <A
HREF="runtime-config-wal.html#GUC-FSYNC"
>fsync</A
> = off. Настройка <TT
CLASS="VARNAME"
>fsync</TT
> касается всего сервера и может изменить поведение всех транзакций. Она выключает всю логику внутри <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>, которая пытается синхронизировать запись отдельных порций в базу данных и, таким образом, крах системы (обусловленный отказом аппаратного обеспечения или операционной системы, который не является сбоем самой СУБД <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> ) может в результате привести к повреждению состояния базы данных. Во многих случаях, асинхронное подтверждение транзакций предоставляет лучшую производительность, чем то, что можно получить выключением <TT
CLASS="VARNAME"
>fsync</TT
>, но без риска повреждения данных.</P
><P
><A
HREF="runtime-config-wal.html#GUC-COMMIT-DELAY"
>commit_delay</A
> также выглядит очень похоже на асинхронное подтверждение транзакций, но по сути это является методом асинхронного подтверждения транзакций (фактически, во время асинхронных транзакций <TT
CLASS="VARNAME"
>commit_delay</TT
> игнорируется). <TT
CLASS="VARNAME"
>commit_delay</TT
> приводит к задержке только перед тем, как синхронная транзакция пытается записать данные <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> на диск, в надежде, что одиночная запись, выполняемая на одну такую транзакцию, сможет также обслужить другие транзакции, которые подтверждаются приблизительно в это же время. Установку этого параметра можно рассматривать как способ увеличения промежутка времени, в течение которого транзакции группируются для единовременной записи на диск. Это распределяет стоимость записи между несколькими транзакциями.</P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="wal-intro.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Начало</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="wal-configuration.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Журнал упреждающей записи (<ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
>)</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Настройка <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>