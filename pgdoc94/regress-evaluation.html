<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Оценка результатов тестирования</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="Документация по PostgreSQL 9.4.1"
HREF="index.html"><LINK
REL="UP"
TITLE="Регрессионные тесты"
HREF="regress.html"><LINK
REL="PREVIOUS"
TITLE="Выполнение тестов"
HREF="regress-run.html"><LINK
REL="NEXT"
TITLE="Вариативные сравнительные файлы"
HREF="regress-variant.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"><META
NAME="creation"
CONTENT="2016-04-12T07:56:57"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>Документация по PostgreSQL 9.4.1</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Выполнение тестов"
HREF="regress-run.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="regress.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Глава 30. Регрессионные тесты</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Вариативные сравнительные файлы"
HREF="regress-variant.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="REGRESS-EVALUATION"
>30.2. Оценка результатов тестирования</A
></H1
><P
>Некоторые правильно установленные и полностью функциональные <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> инсталляции могут <SPAN
CLASS="QUOTE"
>"давать сбой"</SPAN
> при прохождении некоторых регрессионных тестов из-за особенностей, присущих той или иной платформе, таких как различное представление чисел с плавающей запятой и формулировкой сообщений. В настоящее время результаты тестов оцениваются простым <TT
CLASS="COMMAND"
>diff</TT
> сравнением с выводом, сделанным в эталонной системе, поэтому результаты чувствительны к небольшим отличиям между системами. Когда тест завершается со <SPAN
CLASS="QUOTE"
>"сбоем"</SPAN
>, всегда исследуйте разницу между ожидаемым и полученным результатом; возможно, вы обнаружите, что разница не столь уж существенна. Тем не менее, мы стремимся поддерживать эталонные файлы на всех поддерживаемых платформах, чтобы можно было ожидать прохождения всех тестов.</P
><P
>Актуальные итоговые результаты регрессионного тестирования хранятся в каталоге <TT
CLASS="FILENAME"
>src/test/regress/results</TT
>. Тестовый скрипт использует команду <TT
CLASS="COMMAND"
>diff</TT
>, чтобы сравнить каждый итоговый файл с ожидаемыми результатами, которые хранятся в каталоге <TT
CLASS="FILENAME"
>src/test/regress/expected</TT
>. Все различия сохраняются в <TT
CLASS="FILENAME"
>src/test/regress/regression.diffs</TT
> для последующей проверки. (Если проводился тест не из основного пакета, то его результаты появятся в соответствующем подкаталоге, а не в <TT
CLASS="FILENAME"
>src/test/regress</TT
>.)</P
><P
>Если вам не нравится используемая по умолчанию команда <TT
CLASS="COMMAND"
>diff</TT
>, установите переменную среды <TT
CLASS="ENVAR"
>PG_REGRESS_DIFF_OPTS</TT
>, например <TT
CLASS="LITERAL"
>PG_REGRESS_DIFF_OPTS='-u'</TT
>. (Или, если хотите, запустите <TT
CLASS="COMMAND"
>diff</TT
> самостоятельно.)</P
><P
>Если по какой-то причине какая-то конкретная платформа генерирует <SPAN
CLASS="QUOTE"
>"сбой"</SPAN
> для отдельного теста, но изучение его результата убеждает вас, что результат правильный, вы можете добавить новый файл сравнения, чтобы замаскировать отчёт об ошибке для последующего прохождения теста. За подробностями обратитесь к <A
HREF="regress-variant.html"
>Разделу 30.3</A
>.</P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40465"
>30.2.1. Различия в сообщениях об ошибке</A
></H2
><P
>Некоторые регрессионные тесты подставляют заведомо неверные входные значения. Сообщения об ошибке могут выдаваться как <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>, так и самой операционной системой. В последнем случае, форма сообщений может отличаться в зависимости от платформы, но отражают они одну и ту же информацию. Вот эта разница в сообщениях и приводит к <SPAN
CLASS="QUOTE"
>"сбоям"</SPAN
> регрессионного теста, которые можно устранить при проверке.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40470"
>30.2.2. Разница локалей</A
></H2
><P
>Если вы проводите тестирование на сервере, который был установлен с локалью, имеющей порядок сопоставления, отличный от С, вы можете столкнуться с различиями в порядке сортировки и, как следствие, с последующими сбоями. Пакет регрессионных тестов решает эту проблему путём наличия альтернативных файлов результата, которые способны справиться с большим количеством локалей.</P
><P
>Если вы используете метод тестирования на временной инсталляции, то чтобы запустить тестирование на другой локали, используйте подходящую переменную среды, относящуюся к локали, в командной строке <TT
CLASS="COMMAND"
>make</TT
>, например: </P><PRE
CLASS="PROGRAMLISTING"
>make check LANG=de_DE.utf8</PRE
><P> (Драйвер регрессионного теста обнуляет <TT
CLASS="ENVAR"
>LC_ALL</TT
>, поэтому выбор локали посредством данной переменной не работает.) Чтобы не использовать локаль, либо обнулите все переменные среды, относящиеся к локали, либо установите их в <TT
CLASS="LITERAL"
>C</TT
>) или используйте следующую специальную команду: </P><PRE
CLASS="PROGRAMLISTING"
>make check NO_LOCALE=1</PRE
><P> Когда тест проходит на существующей инсталляции, установки локали определяются этой инсталляцией. Чтобы это изменить, инициализируйте кластер базы данных с иной локалью, передав соответствующие параметры <TT
CLASS="COMMAND"
>initdb</TT
>.</P
><P
>В целом, рекомендуется по возможности проводить регрессионные тесты при таких установках локали, которые будут использованы в работе, тогда в результате тестирования будут проверены актуальные участки кода, относящиеся к локали и кодировке. В зависимости от окружения операционной системы, вы можете столкнуться со сбоями, но вы хотя бы будете знать, какого поведения локали можно ожидать при работе с реальными приложениями.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40481"
>30.2.3. Разница в дате и времени</A
></H2
><P
>Большая часть результатов проверки даты и времени зависит от часового пояса окружения. Эталонные файлы созданы для пояса <TT
CLASS="LITERAL"
>PST8PDT</TT
> (Беркли, Калифорния), поэтому если проводить тесты не с этим часовым поясом, проявятся мнимые ошибки. Драйвер регрессионного теста задаёт переменную среды <TT
CLASS="ENVAR"
>PGTZ</TT
> как <TT
CLASS="LITERAL"
>PST8PDT</TT
>, что позволяет получить корректный результат.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40487"
>30.2.4. Разница в числах с плавающей запятой</A
></H2
><P
>Некоторые тесты применяют 64-битное вычисление чисел с плавающей запятой (<TT
CLASS="TYPE"
>double precision</TT
>) из столбцов таблицы. Наблюдаются различия в результатах при использовании математических функций для столбцов <TT
CLASS="TYPE"
>double precision</TT
>. Тесты <TT
CLASS="LITERAL"
>float8</TT
> и <TT
CLASS="LITERAL"
>geometry</TT
> особенно чувствительны к небольшим различиям между платформами и даже режимами оптимизации компилятора. Чтобы понять реальную значимость этих различий, нужно сравнить их глазами, поскольку обычно они располагаются с десятого разряда справа от десятичной точки.</P
><P
>Некоторые системы показывают минус ноль как <TT
CLASS="LITERAL"
>-0</TT
>, тогда как другие показывают просто <TT
CLASS="LITERAL"
>0</TT
>.</P
><P
>Некоторые системы сигнализируют об ошибках в <CODE
CLASS="FUNCTION"
>pow()</CODE
> и <CODE
CLASS="FUNCTION"
>exp()</CODE
> не так, как предполагает текущий <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> код.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40501"
>30.2.5. Разница в сортировке строк</A
></H2
><P
>Иногда наблюдаются различия в том, что одни и те же строки выводятся в ином порядке, нежели в контрольном файле. В большинстве случаев это не является, строго говоря, ошибкой. Основная часть скриптов регрессионных тестов не столь педантична, чтобы использовать <TT
CLASS="LITERAL"
>ORDER BY</TT
> для каждого <TT
CLASS="LITERAL"
>SELECT</TT
>, и поэтому в результате порядок строк не гарантирован согласно спецификации SQL. На практике мы видим, как одинаковые запросы, выполняемые для одних и тех же данных на одном и том же программном обеспечении, выдают результаты в одинаковом порядке для всех платформ, в связи с чем отсутствие <TT
CLASS="LITERAL"
>ORDER BY</TT
> не является проблемой. Однако некоторые запросы выявляют межплатформенные различия в сортировке. Когда тестирование идет на уже установленном сервере, различия в сортировке могут быть следствием того, что локаль установлена в отличное от С значение, или некоторые параметры заданы не по умолчанию, такие как <TT
CLASS="VARNAME"
>work_mem</TT
> или стоимостные параметры планировщика.</P
><P
>Поэтому, если вы видите различия в сортировке строк, не стоит волноваться, если только запрос не использует <TT
CLASS="LITERAL"
>ORDER BY</TT
>. Тем не менее, сообщайте нам о таких случаях, чтобы мы могли добавить <TT
CLASS="LITERAL"
>ORDER BY</TT
> в конкретный запрос, чтобы исключить возможность ошибки в будущих релизах.</P
><P
>Вы можете задать вопрос, почему мы явно не добавили <TT
CLASS="LITERAL"
>ORDER BY</TT
> во все запросы регрессионных тестов, чтобы избавиться от таких ошибок раз и навсегда. Причина в том, что это снизит полезность регрессионных тестов, поскольку они будут иметь тенденцию к проверке планов запросов использующих сортировку, за счёт исключения запросов без сортировки.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40513"
>30.2.6. Недостаточная глубина стека</A
></H2
><P
>Если <TT
CLASS="LITERAL"
>ошибки </TT
> теста приводят к поломке сервера при выполнении команды <TT
CLASS="LITERAL"
>select infinite_recurse()</TT
>, это означает, что предел платформы для размера стека меньше, чем показывает параметр <A
HREF="runtime-config-resource.html#GUC-MAX-STACK-DEPTH"
>max_stack_depth</A
>. Проблема может быть решена запуском сервера с большим размером стека (рекомендованное значение <TT
CLASS="VARNAME"
>max_stack_depth</TT
> по умолчанию - 4 Мб). Если вы не можете этого сделать, в качестве альтернативы уменьшите значение <TT
CLASS="VARNAME"
>max_stack_depth</TT
>.</P
><P
>На платформах, поддерживающих функцию <CODE
CLASS="FUNCTION"
>getrlimit()</CODE
>, сервер должен автоматически выбирать значение переменной <TT
CLASS="VARNAME"
>max_stack_depth</TT
>; поэтому, если вы не переписывали это значение вручную, сбой такого типа — просто дефект, который нужно зарегистрировать.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40524"
>30.2.7. Тест <SPAN
CLASS="QUOTE"
>"случайных значений"</SPAN
></A
></H2
><P
>Тестовый скрипт <TT
CLASS="LITERAL"
>random</TT
> подразумевает получение случайных значений. В очень редких случаях это приводит к сбоям в регрессионном тестировании. Выполнение </P><PRE
CLASS="PROGRAMLISTING"
>diff results/random.out expected/random.out</PRE
><P> должно выводить одну или несколько строк различий. Нет причин для беспокойства, до тех пор пока сбои в этом тесте не повторяются постоянно.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN40530"
>30.2.8. Параметры конфигурации</A
></H2
><P
>Когда тестирование проходит на существующей инсталляции, некоторые нестандартные значения параметров могут привести к сбоям в тесте. Например, изменение таких параметров конфигурации, как <TT
CLASS="VARNAME"
>enable_seqscan</TT
> или <TT
CLASS="VARNAME"
>enable_indexscan</TT
> могут привести к такому изменению системы, которое сможет воздействовать на результаты тестов, использующих <TT
CLASS="COMMAND"
>EXPLAIN</TT
>.</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="regress-run.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Начало</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="regress-variant.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Выполнение тестов</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="regress.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Вариативные сравнительные файлы</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>