<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Надёжность</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="Документация по PostgreSQL 9.4.1"
HREF="index.html"><LINK
REL="UP"
TITLE="Надёжность и журнал упреждающей записи"
HREF="wal.html"><LINK
REL="PREVIOUS"
TITLE="Надёжность и журнал упреждающей записи"
HREF="wal.html"><LINK
REL="NEXT"
TITLE="Журнал упреждающей записи (WAL)"
HREF="wal-intro.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"><META
NAME="creation"
CONTENT="2016-04-12T07:56:57"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>Документация по PostgreSQL 9.4.1</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Надёжность и журнал упреждающей записи"
HREF="wal.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Глава 29. Надёжность и журнал упреждающей записи</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Журнал упреждающей записи (WAL)"
HREF="wal-intro.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WAL-RELIABILITY"
>29.1. Надёжность</A
></H1
><P
>Надёжность — это важное свойство любой серьёзной СУБД и <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> делает всё возможное, чтобы гарантировать надёжность своего функционирования. Один из аспектов надёжности состоит в том, что все данные записываются с помощью подтверждённых транзакций, которые сохраняются в энергонезависимой области, которая защищена от потери питания, сбоев операционной системы и аппаратных отказов (разумеется, за исключением отказа самой энергонезависимой области). Успешная запись данных в постоянное место хранения (диск или эквивалентный носитель) обычно всё, что требуется. Фактически, даже если компьютер полностью вышел из строя, если диски выжили, то они могут быть переставлены в другой похожий компьютер и все подтверждённые транзакции останутся неповреждёнными.</P
><P
>Хотя периодическая запись данных на пластины диска может выглядеть как простая операция, это не так, потому что диски значительно медленнее, чем оперативная память и процессор, а также потому что между оперативной памятью и пластинами диска есть некоторые механизмы кеширования. Во-первых, есть буферный кеш операционной системы, который кеширует частые запросы к блокам диска и комбинирует запись на диск. К счастью, все операционные системы предоставляют приложениям способ принудительной записи из буферного кеша на диск и <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> использует эту возможность. (Смотрите параметр <A
HREF="runtime-config-wal.html#GUC-WAL-SYNC-METHOD"
>wal_sync_method</A
> который отвечает за то как это делается.)</P
><P
>Далее, кеширование также может осуществляться контроллером диска; в особенности это касается <ACRONYM
CLASS="ACRONYM"
>RAID</ACRONYM
>-контроллеров. В некоторых случаях это кеширование работает в режиме <I
CLASS="FIRSTTERM"
>сквозной записи</I
>, что означает, что запись осуществляется на диск как только приходят данные. В других случаях, возможна работа в режиме <I
CLASS="FIRSTTERM"
>отложенной записи</I
>, что означает, что запись осуществляется некоторое время спустя. Такой режим кеширования может создавать риск для надёжности, потому что память контроллера диска непостоянна и будет потеряна в случае потери питания. Лучшие контроллеры имеют так называемую <I
CLASS="FIRSTTERM"
>батарею резервного питания</I
> (Battery-Backup Unit, <ACRONYM
CLASS="ACRONYM"
>BBU</ACRONYM
>), которая сохраняет кеш контроллера на батарее, если пропадёт системное питание. После возобновления питания, данные, оставшиеся в кеше контроллера, будут записаны на диски.</P
><P
>И наконец, многие диски имеют кеширование. На каких-то дисках оно работает в режиме сквозной записи, на других в режиме отложенной записи, что приводит к тем же проблемам потери данных для кеша отложенной записи, что и с кешем в контроллерах дисков. Диски IDE и SATA, потребительского класса особенно, часто имеют кеш отложенной записи, который сбрасывается при потере питания. Многие SSD-накопители также имеют зависимый от питания кеш отложенной записи.</P
><P
>Обычно, такое кеширование можно выключить; однако, то, как это делается, различается для операционной системы и для типа диска:</P
><P
></P
><UL
><LI
><P
>В <SPAN
CLASS="PRODUCTNAME"
>Linux</SPAN
> параметры дисков IDE и SATA могут быть получены с помощью команды <TT
CLASS="COMMAND"
>hdparm -I</TT
>; кеширование записи включено, если за строкой <TT
CLASS="LITERAL"
>Write cache</TT
> следует <TT
CLASS="LITERAL"
>*</TT
>. Для выключения кеширования записи может быть использована команда <TT
CLASS="COMMAND"
>hdparm -W 0</TT
>. Параметры SCSI-дисков могут быть получены с помощью утилиты <A
HREF="http://sg.danny.cz/sg/sdparm.html"
TARGET="_top"
><SPAN
CLASS="APPLICATION"
>sdparm</SPAN
></A
>. Используйте <TT
CLASS="COMMAND"
>sdparm --get=WCE</TT
>, чтобы проверить, включено ли кеширование записи, и <TT
CLASS="COMMAND"
>sdparm --clear=WCE</TT
>, чтобы выключить его.</P
></LI
><LI
><P
>Во <SPAN
CLASS="PRODUCTNAME"
>FreeBSD</SPAN
> параметры IDE-дисков могут быть получены с помощью команды <TT
CLASS="COMMAND"
>atacontrol</TT
>, а кеширование записи выключается при помощи установки параметра <TT
CLASS="LITERAL"
>hw.ata.wc=0</TT
> в файле <TT
CLASS="FILENAME"
>/boot/loader.conf</TT
>; Для SCSI-дисков параметры могут быть получены, используя команду <TT
CLASS="COMMAND"
>camcontrol identify</TT
>, а кеширование записи изменяется при помощи утилиты <TT
CLASS="COMMAND"
>sdparm</TT
>.</P
></LI
><LI
><P
>В <SPAN
CLASS="PRODUCTNAME"
>Solaris</SPAN
> кешированием записи на диск управляет команда <TT
CLASS="COMMAND"
>format -e</TT
>. (Использование файловой системы Solaris <ACRONYM
CLASS="ACRONYM"
>ZFS</ACRONYM
>, при включённом кешировании записи на диск, является безопасным, потому что она использует собственные команды сброса кеша на диск.)</P
></LI
><LI
><P
>В <SPAN
CLASS="PRODUCTNAME"
>Windows</SPAN
>, если параметр <TT
CLASS="VARNAME"
>wal_sync_method</TT
> установлен в <TT
CLASS="LITERAL"
>open_datasync</TT
> (по умолчанию), кеширование записи на диск может быть выключено снятием галочки <TT
CLASS="LITERAL"
>My Computer\Open\<TT
CLASS="REPLACEABLE"
><I
>disk drive</I
></TT
>\Properties\Hardware\Properties\Policies\Enable write caching on the disk</TT
>. В качестве альтернативы, можно установить параметр <TT
CLASS="VARNAME"
>wal_sync_method</TT
> в значение <TT
CLASS="LITERAL"
>fsync</TT
> или <TT
CLASS="LITERAL"
>fsync_writethrough</TT
>, что предотвращает кеширование записи.</P
></LI
><LI
><P
>В <SPAN
CLASS="PRODUCTNAME"
>OS X</SPAN
> кеширование записи можно отключить, установив для параметра <TT
CLASS="VARNAME"
>wal_sync_method</TT
> значение <TT
CLASS="LITERAL"
>fsync_writethrough</TT
>.</P
></LI
></UL
><P
>Новые модели SATA-дисков (которые соответствуют стандарту <ACRONYM
CLASS="ACRONYM"
>ATAPI-6</ACRONYM
> или более позднему) предлагают команду сброса кеша на диск (<TT
CLASS="COMMAND"
>FLUSH CACHE EXT</TT
>), а SCSI-диски уже давно поддерживают похожую команду <TT
CLASS="COMMAND"
>SYNCHRONIZE CACHE</TT
>. Эти команды недоступны из <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> напрямую, но некоторые файловые системы (например, <ACRONYM
CLASS="ACRONYM"
>ZFS</ACRONYM
>, <ACRONYM
CLASS="ACRONYM"
>ext4</ACRONYM
>), могут использовать их для сброса данных из кеша на пластины диска при включённом режиме кеша сквозной записи. К сожалению, такие файловые системы ведут себя неоптимально при комбинировании с батареей резервного питания (<ACRONYM
CLASS="ACRONYM"
>BBU</ACRONYM
>) дискового контроллера. В таких случаях, команда синхронизации принуждает сохранять все данные на диск из кеша контроллера, сводя преимущество BBU к нулю. Вы можете запустить модуль <A
HREF="pgtestfsync.html"
>              <SPAN
CLASS="APPLICATION"
>pg_test_fsync</SPAN
>
            </A
>, чтобы увидеть, что вы попали в эту ситуацию. Если это так, преимущества производительности BBU могут быть восстановлены с помощью выключения барьеров записи для файловой системы или переконфигурирования контроллера диска, если это возможно. Если барьеры записи выключены, убедитесь, что батарея годная; при отказе батареи может произойти потеря данных. Есть надежда, что разработчики файловых систем и контроллеров дисков, в конце концов, устранят это неоптимальное поведение.</P
><P
>Когда операционная система отправляет запрос на запись к аппаратному обеспечению для хранения данных, она мало что может сделать, чтобы убедиться, что данные действительно сохранены в какой-либо энергонезависимой области. Скорее, это является зоной ответственности администратора, убедиться в целостности данных на всех компонентах хранения. Избегайте дисковых контроллеров, которые не имеют батарей резервного питания для кеширования записи. На уровне диска, запретите режим отложенной записи, если диск не может гарантировать, что данные будут записаны перед выключением. Если вы используете SSD, знайте, что многие их них по умолчанию не выполняют команды сброса кеша на диск. Вы можете протестировать надёжность поведения подсистемы ввода/вывода, используя <A
HREF="http://brad.livejournal.com/2116715.html"
TARGET="_top"
><TT
CLASS="FILENAME"
>diskchecker.pl</TT
></A
>.</P
><P
>Другой риск потери данных состоит в самой записи на пластины диска. Пластины диска разделяются на секторы, обычно по 512 байт каждый. Каждая операция физического чтения или записи обрабатывает целый сектор. Когда дисковый накопитель получает запрос на запись, он может соответствовать нескольким секторам по 512 байт (<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> обычно за один раз записывает 8192 байта или 16 секторов) и из-за отказа питания процесс записи может закончится неудачей в любое время, что означает, что некоторые из 512-байтовых секторов будут записаны, а некоторые нет. Чтобы защититься от таких сбоев, <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>перед</I
></SPAN
> изменением фактической страницы на диске, <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> периодически записывает полные образы страниц на постоянное устройство хранения WAL. С помощью этого, во время восстановления после краха, <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> может восстановить из WAL страницы, которые записаны частично. Если у вас файловая система, которая защищена от частичной записи страниц (например, ZFS), вы можете выключить работу с образами страниц, выключив параметр <A
HREF="runtime-config-wal.html#GUC-FULL-PAGE-WRITES"
>full_page_writes</A
>. Батарея резервного питания (BBU) контроллера диска не защищает от частичной записи страниц, если не гарантируется, что данные записаны в BBU как полные (8kB) страницы.</P
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> также защищает от некоторых видов повреждения данных на устройствах хранения, которые могут произойти из-за аппаратных ошибок или из-за дефектов поверхности с течением времени, например, при операциях чтения/записи во время сборки мусора. <P
></P
></P><UL
><LI
><P
>Каждая индивидуальная запись в WAL защищена с помощью контрольной суммы по алгоритму CRC-32 (32-bit), что позволяет судить о корректности данных в записи. Значение CRC устанавливается, когда мы пишем каждую запись WAL и проверяется в ходе восстановления после сбоя, восстановления из архива, и при репликации.</P
></LI
><LI
><P
>Страницы данных в настоящее время не защищаются контрольными суммами по умолчанию, хотя полные образы страниц, записанные в WAL будут защищены; смотрите <A
HREF="app-initdb.html#APP-INITDB-DATA-CHECKSUMS"
><SPAN
CLASS="APPLICATION"
>initdb</SPAN
></A
> для деталей о включении в страницы данных информации о контрольных суммах.</P
></LI
><LI
><P
>Для внутренних структур данных, таких как <TT
CLASS="FILENAME"
>pg_clog</TT
>, <TT
CLASS="FILENAME"
>pg_subtrans</TT
>, <TT
CLASS="FILENAME"
>pg_multixact</TT
>, <TT
CLASS="FILENAME"
>pg_serial</TT
>, <TT
CLASS="FILENAME"
>pg_notify</TT
>, <TT
CLASS="FILENAME"
>pg_stat</TT
>, <TT
CLASS="FILENAME"
>pg_snapshots</TT
> не ведётся расчёт контрольной суммы, равно как и для страниц, защищённых посредством полностраничной записи. Однако там, где такие структуры данных являются постоянными, записи WAL пишутся таким образом, чтобы после сбоя было возможно аккуратно повторить последние изменения, а эти записи WAL защищаются так же, как описано выше.</P
></LI
><LI
><P
>Файлы каталога <TT
CLASS="FILENAME"
>pg_twophase</TT
> защищены с помощью контрольной суммы CRC-32.</P
></LI
><LI
><P
>Временные файлы данных, используемые в больших SQL-запросах для сортировки, материализации и промежуточных результатов, в настоящее время не защищаются контрольной суммой, а изменения в этих файлах не отражаются в WAL.</P
></LI
></UL
><P></P
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> не защищает от корректируемых ошибок памяти; предполагается, что вы будете работать с памятью, которая использует промышленный стандарт коррекции ошибок (ECC, Error Correcting Codes) или лучшую защиту.</P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Начало</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="wal-intro.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Надёжность и журнал упреждающей записи</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Журнал упреждающей записи (<ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
>)</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>