<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Дерево запроса</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="Документация по PostgreSQL 9.4.1"
HREF="index.html"><LINK
REL="UP"
TITLE="Система правил"
HREF="rules.html"><LINK
REL="PREVIOUS"
TITLE="Система правил"
HREF="rules.html"><LINK
REL="NEXT"
TITLE="Система правил и представления"
HREF="rules-views.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"><META
NAME="creation"
CONTENT="2016-04-12T07:56:57"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>Документация по PostgreSQL 9.4.1</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Система правил"
HREF="rules.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Глава 38. Система правил</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Система правил и представления"
HREF="rules-views.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="QUERYTREE"
>38.1. Дерево запроса</A
></H1
><P
>Чтобы понять, как работает система правил, нужно знать, когда она вызывается, что принимает на вход и какой результат выдаёт.</P
><P
>Система правил внедрена между анализатором запросов и планировщиком. Она принимает разобранный запрос, одно дерево запроса, и определённые пользователем правила перезаписи, тоже представленные деревьями с некоторой дополнительной информацией, и создаёт некоторое количество деревьев запросов в результате. Таким образом, на входе и выходе этой системы оказывается то, что может сформировать анализатор запросов, и как следствие, всё, с чем работает эта система, представимо в виде операторов <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>.</P
><P
>Так что же такое дерево запроса? Это внутреннее представление оператора <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>, в котором все образующие его части хранятся отдельно. Эти деревья можно увидеть в журнале сервера, если установить параметры конфигурации <TT
CLASS="VARNAME"
>debug_print_parse</TT
>, <TT
CLASS="VARNAME"
>debug_print_rewritten</TT
> или <TT
CLASS="VARNAME"
>debug_print_plan</TT
>. Действия правил также хранятся в виде деревьев запросов, в системном каталоге <TT
CLASS="STRUCTNAME"
>pg_rewrite</TT
>. Они не форматируются как при выводе в журнал, но содержат точно такую же информацию.</P
><P
>Для прочтения неформатированного дерева требуется некоторый навык. Но так как представления дерева запросов в виде <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
> достаточно, чтобы понять систему правил, в этой главе не будет рассказываться, как их читать.</P
><P
>Читая <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>-представления деревьев запросов в этой главе, необходимо понимать, на какие части разбивается оператор, когда он преобразуется в структуру дерева запроса. Дерево запроса состоит из следующих частей: <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
>тип команды</DT
><DD
><P
>Это простое значение, говорящее, какая команда (<TT
CLASS="COMMAND"
>SELECT</TT
>, <TT
CLASS="COMMAND"
>INSERT</TT
>, <TT
CLASS="COMMAND"
>UPDATE</TT
> или <TT
CLASS="COMMAND"
>DELETE</TT
>) сгенерировала дерево запросов.</P
></DD
><DT
>список отношений </DT
><DD
><P
>Список отношений представляет собой массив отношений, используемых в запросе. В запросе <TT
CLASS="COMMAND"
>SELECT</TT
> он включает отношения, указанные после ключевого слова <TT
CLASS="LITERAL"
>FROM</TT
>.</P
><P
>Каждый элемент списка отношений представляет таблицу или представление и говорит, с каким именем они упоминаются в других частях запроса. В дереве запросов записываются номера элементов списка отношений, а не их имена, поэтому для него неактуальна проблема дублирования имён, как для оператора <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>. Такая проблема может возникнуть при объединении списков отношений, образованных разными правилами. В этой главе данная ситуация рассматриваться не будет.</P
></DD
><DT
>результирующее отношение</DT
><DD
><P
>Индекс в списке отношений, указывающий на отношение, которое будет получать результаты запроса.</P
><P
>В запросах <TT
CLASS="COMMAND"
>SELECT</TT
> результирующее отношение отсутствует. (Особый случай <TT
CLASS="COMMAND"
>SELECT INTO</TT
> практически равнозначен <TT
CLASS="COMMAND"
>CREATE TABLE</TT
> с последующим <TT
CLASS="LITERAL"
>INSERT ... SELECT</TT
> и здесь отдельно не рассматривается.)</P
><P
>Для команд <TT
CLASS="COMMAND"
>INSERT</TT
>, <TT
CLASS="COMMAND"
>UPDATE</TT
> и <TT
CLASS="COMMAND"
>DELETE</TT
> результирующим отношением будет таблица (или представление!), в которой будут происходить изменения.</P
></DD
><DT
>выходной список </DT
><DD
><P
>Выходной список — это список выражений, определяющих результат запроса. В случае <TT
CLASS="COMMAND"
>SELECT</TT
>, это выражения, которые образуют окончательный набор выходных данных. Они соответствуют выражениям, записанным между ключевыми словами <TT
CLASS="COMMAND"
>SELECT</TT
> и <TT
CLASS="COMMAND"
>FROM</TT
>. (Указание <TT
CLASS="LITERAL"
>*</TT
> — это просто краткое обозначение имён всех колонок отношения. Анализатор разворачивает его в список отдельных колонок, так что система правил никогда не видит его.)</P
><P
>Командам <TT
CLASS="COMMAND"
>DELETE</TT
> не нужен обычный выходной список, так как они не выдают никакие результаты. Вместо этого, система правил добавляет в пустой выходной список специальную запись <ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
>, чтобы исполнитель мог найти удаляемую строку. (<ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
> добавляется, когда результирующее отношение — обычная таблица. Если это представление, добавляется переменная, содержащая всю строку, как рассказывается в <A
HREF="rules-views.html#RULES-VIEWS-UPDATE"
>Подразделе 38.2.4</A
>.)</P
><P
>Для команд <TT
CLASS="COMMAND"
>INSERT</TT
> выходной список описывает новые строки, которые должны попасть в результирующее отношение. Он включает выражения в предложении <TT
CLASS="LITERAL"
>VALUES</TT
> или предложении <TT
CLASS="COMMAND"
>SELECT</TT
> в <TT
CLASS="LITERAL"
>INSERT ... SELECT</TT
>. На первом этапе процесс перезаписи добавляет элементы выходного списка для колонок, которым ничего не присвоила исходная команда, но имеющих значения по умолчанию. Все остальные колонки (без заданного значения и значения по умолчанию) планировщик заполняет константой NULL.</P
><P
>Для команд <TT
CLASS="COMMAND"
>UPDATE</TT
> выходной список описывает новые строки, которые должны заменить старые. В системе правил он содержит только выражения из части <TT
CLASS="LITERAL"
>SET колонка = выражение</TT
>. Для пропущенных колонок планировщик вставляет выражения, копирующие значения из старой строки в новую. Так же, как и с командой <TT
CLASS="COMMAND"
>DELETE</TT
>, система правил добавляет ещё <ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
> или переменную со всей строкой, чтобы исполнитель мог найти изменяемую старую строку.</P
><P
>Каждая запись в выходном списке содержит выражение, которое может быть константой, переменной, указывающей на колонку отношения в таблице отношений, параметром или деревом выражений, образованным из констант, переменных, операторов, вызовов функций и т. д.</P
></DD
><DT
>условие фильтра</DT
><DD
><P
>Условие фильтра запроса — это выражение, во многом похожее на те, что содержатся в выходном списке. Результат этого выражения — логический, он говорит, должна ли выполняться операция (<TT
CLASS="COMMAND"
>INSERT</TT
>, <TT
CLASS="COMMAND"
>UPDATE</TT
>, <TT
CLASS="COMMAND"
>DELETE</TT
> или <TT
CLASS="COMMAND"
>SELECT</TT
>) для данной строки в результате. Оно соответствует предложению <TT
CLASS="LITERAL"
>WHERE</TT
> <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>-оператора.</P
></DD
><DT
>дерево соединения</DT
><DD
><P
>Дерево соединения запроса показывает структуру предложения <TT
CLASS="LITERAL"
>FROM</TT
>. Для простых запросов вида <TT
CLASS="LITERAL"
>SELECT ... FROM a, b, c</TT
>, дерево соединения — это просто список элементов <TT
CLASS="LITERAL"
>FROM</TT
>, так как они могут соединяться в любом порядке. Но с выражениями <TT
CLASS="LITERAL"
>JOIN</TT
>, особенно с внешними соединениями, приходится соединять отношения именно в заданном порядке. В этом случае дерево соединения отражает структуру выражений <TT
CLASS="LITERAL"
>JOIN</TT
>. Ограничения, связанные с конкретными предложениями <TT
CLASS="LITERAL"
>JOIN</TT
> (из выражений <TT
CLASS="LITERAL"
>ON</TT
> или <TT
CLASS="LITERAL"
>USING</TT
>), тоже сохраняются в виде условных выражений, добавленных к соответствующим узлам дерева соединения. Как оказалось, выражение <TT
CLASS="LITERAL"
>WHERE</TT
> верхнего уровня тоже удобно хранить как условие, добавленное к элементу верхнего уровня дерева соединения. Поэтому в дереве соединения на самом деле представляются оба предложения оператора <TT
CLASS="COMMAND"
>SELECT</TT
> — <TT
CLASS="LITERAL"
>FROM</TT
> и <TT
CLASS="LITERAL"
>WHERE</TT
>.</P
></DD
><DT
>другие</DT
><DD
><P
>Другие части дерева запроса, например, предложение <TT
CLASS="LITERAL"
>ORDER BY</TT
>, в данном контексте не представляют интереса. Система правил выполняет в них некоторые подстановки, применяя правила, но это не имеет непосредственного отношения к основам системы правил.</P
></DD
></DL
></DIV
><P></P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Начало</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="rules-views.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Система правил</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Система правил и представления</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>