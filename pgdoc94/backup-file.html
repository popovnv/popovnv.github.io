<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Резервное копирование на уровне файлов</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="Документация по PostgreSQL 9.4.1"
HREF="index.html"><LINK
REL="UP"
TITLE="Резервное копирование и восстановление"
HREF="backup.html"><LINK
REL="PREVIOUS"
TITLE="Выгрузка в SQL"
HREF="backup-dump.html"><LINK
REL="NEXT"
TITLE="Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR)"
HREF="continuous-archiving.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"><META
NAME="creation"
CONTENT="2016-04-12T07:56:57"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>Документация по PostgreSQL 9.4.1</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Выгрузка в SQL"
HREF="backup-dump.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="backup.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Глава 24. Резервное копирование и восстановление</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR)"
HREF="continuous-archiving.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="BACKUP-FILE"
>24.2. Резервное копирование на уровне файлов</A
></H1
><P
>Альтернативной стратегией резервного копирования является непосредственное копирование файлов, в которых <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> хранит содержимое базы данных; в <A
HREF="creating-cluster.html"
>Разделе 17.2</A
> рассказывается, где находятся эти файлы. Вы можете использовать любой способ копирования файлов по желанию, например: </P><PRE
CLASS="PROGRAMLISTING"
>tar -cf backup.tar /usr/local/pgsql/data</PRE
><P></P
><P
>Однако, существуют два ограничения, которые делают этот метод непрактичным или как минимум менее предпочтительным по сравнению с <SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>: <P
></P
></P><OL
TYPE="1"
><LI
><P
>Чтобы полученная резервная копия была годной, сервер баз данных <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>должен</I
></SPAN
> быть остановлен. Такие полумеры, как запрещение всех подключений к серверу, работать <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>не</I
></SPAN
> будут (отчасти потому что <TT
CLASS="COMMAND"
>tar</TT
> и подобные средства не получают мгновенный снимок состояния файловой системы, но ещё и потому, что в сервере есть внутренние буферы). Узнать о том, как остановить сервер, можно в <A
HREF="server-shutdown.html"
>Разделе 17.5</A
>. Необходимо отметить, что сервер нужно будет остановить и перед восстановлением данных.</P
></LI
><LI
><P
>Если вы ознакомились с внутренней организацией базы данных в файловой системе, у вас может возникнуть соблазн скопировать или восстановить только отдельные таблицы или базы данных в соответствующих файлах или каталогах. Это <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>не</I
></SPAN
> будет работать, потому что информацию, содержащуюся в этих файлах, нельзя использовать без файлов журналов транзакций, <TT
CLASS="FILENAME"
>pg_clog/*</TT
>, которые содержат состояние всех транзакций. Без этих данных файлы таблиц непригодны к использованию. Разумеется также невозможно восстановить только одну таблицу и соответствующие данные <TT
CLASS="FILENAME"
>pg_clog</TT
>, потому что в результате нерабочими станут все другие таблицы в кластере баз данных. Таким образом, копирование на уровне файловой системы будет работать, только если выполняется полное копирование и восстановление всего кластера баз данных.</P
></LI
></OL
><P></P
><P
>Ещё один подход к резервному копированию файловой системы заключается в создании <SPAN
CLASS="QUOTE"
>"целостного снимка"</SPAN
> каталога с данными, если это поддерживает файловая система (и вы склонны считать, что эта функциональность реализована корректно). Типичная процедура включает создание <SPAN
CLASS="QUOTE"
>"замороженного снимка"</SPAN
> тома, содержащего базу данных, затем копирование всего каталога с данными (а не его избранных частей, см. выше) из этого снимка на устройство резервного копирования, и наконец освобождение замороженного снимка. При этом сервер базы данных может не прекращать свою работу. Однако резервная копия, созданная таким способом, содержит файлы базы данных в таком состоянии, как если бы сервер баз данных не был остановлен штатным образом; таким образом, когда вы запустите сервер баз данных с сохранёнными данными, он будет считать, что до этого процесс сервера был прерван аварийно, и будет накатывать журнал WAL. Это не проблема, просто имейте это в виду (и обязательно включите файлы WAL в резервную копию). Чтобы сократить время восстановления, можно выполнить команду <TT
CLASS="COMMAND"
>CHECKPOINT</TT
> перед созданием снимка.</P
><P
>Если ваша база данных размещена в нескольких файловых системах, получить в точности одновременно замороженные снимки всех томов может быть невозможно. Например, если файлы данных и журналы WAL находятся на разных дисках или табличные пространства расположены в разных файловых системах, резервное копирование со снимками может быть неприменимо, потому что снимки <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>должны</I
></SPAN
> быть одновременными. В таких ситуациях очень внимательно изучите документацию по вашей файловой системе, прежде чем довериться технологии согласованных снимков.</P
><P
>Если одновременные снимки невозможны, остаётся вариант с остановкой сервера баз данных на время, достаточное для получения всех замороженных снимков. Другое возможное решение — получить базовую копию путём непрерывного архивирования (см. <A
HREF="continuous-archiving.html#BACKUP-BASE-BACKUP"
>Подраздел 24.3.2</A
>), такие резервные копии не могут пострадать от изменений файловой системы в процессе резервного копирования. Для этого требуется включить непрерывное архивирование только на время резервного копирования; для восстановления применяется процедура восстановления из непрерывного архива (<A
HREF="continuous-archiving.html#BACKUP-PITR-RECOVERY"
>Подраздел 24.3.4</A
>).</P
><P
>Ещё один вариант — копировать содержимое файловой системы с помощью <SPAN
CLASS="APPLICATION"
>rsync</SPAN
>. Для этого <SPAN
CLASS="APPLICATION"
>rsync</SPAN
> запускается сначала во время работы сервера баз данных, а затем сервер останавливается на время, достаточное для второго запуска <SPAN
CLASS="APPLICATION"
>rsync</SPAN
>. Во второй раз rsync отработает намного быстрее, чем в первый, потому что скопировать надо будет относительно немного данных; и в итоге будет получен согласованный результат, так как сервер был остановлен. Данный метод позволяет получить копию на уровне файловой системы с минимальным временем простоя.</P
><P
>Обратите внимание, что размер копии на уровне файлов обычно больше, чем дампа SQL. (Программе <SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
> не нужно, например, записывать содержимое индексов, достаточно команд для их пересоздания). Однако копирование на уровне файлов может выполняться быстрее.</P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="backup-dump.html"
ACCESSKEY="P"
>Пред.</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Начало</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="continuous-archiving.html"
ACCESSKEY="N"
>След.</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Выгрузка в <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="backup.html"
ACCESSKEY="U"
>Уровень выше</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR)</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>